// Prisma schema for Takoss Template Library
// This defines the database structure for storing reusable prompt templates

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Prompt Template model - stores reusable parameterized templates
model PromptTemplate {
  id          String   @id @default(uuid())
  name        String
  description String
  template    String   @db.Text // Large text field for template content
  variables   String[] // Array of variable names used in template
  category    TemplateCategory
  modelType   ModelType?

  // Versioning
  version     Int      @default(1)
  isActive    Boolean  @default(true)

  // Examples for few-shot learning
  examples    TemplateExample[]

  // Usage tracking
  usageCount  Int      @default(0)
  lastUsedAt  DateTime?

  // Metadata
  tags        String[] // For search and filtering
  metadata    Json?    // Flexible metadata storage

  // Timestamps
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  createdBy   String?  // Future: user ID who created template

  // Relations
  parent      PromptTemplate?  @relation("TemplateVersions", fields: [parentId], references: [id])
  parentId    String?
  versions    PromptTemplate[] @relation("TemplateVersions")

  @@index([category])
  @@index([modelType])
  @@index([isActive])
  @@index([tags])
  @@map("prompt_templates")
}

// Template Examples - stores example inputs/outputs for templates
model TemplateExample {
  id         String   @id @default(uuid())
  template   PromptTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)
  templateId String

  input      Json     // Example input variables
  output     String   @db.Text // Expected output

  createdAt  DateTime @default(now())

  @@map("template_examples")
}

// Template execution history for analytics
model TemplateExecution {
  id              String   @id @default(uuid())
  templateId      String
  templateName    String   // Denormalized for faster queries

  // Execution details
  chainId         String
  taskId          String
  modelType       ModelType

  // Performance metrics
  executionTime   Int      // Milliseconds
  promptTokens    Int
  completionTokens Int

  // Result
  status          ExecutionStatus
  outputLength    Int?     // Length of generated output
  error           String?

  // Timestamp
  executedAt      DateTime @default(now())

  @@index([templateId])
  @@index([chainId])
  @@index([executedAt])
  @@map("template_executions")
}

// Template Collections - group related templates
model TemplateCollection {
  id          String   @id @default(uuid())
  name        String
  description String?

  // Template IDs in this collection (using string array for simplicity)
  templateIds String[]

  isPublic    Boolean  @default(false)
  createdBy   String?

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("template_collections")
}

// Enums
enum TemplateCategory {
  FRONTEND
  BACKEND
  DATABASE
  AUTH
  TESTING
  DEPLOYMENT
  OTHER
}

enum ModelType {
  CLAUDE
  GEMINI
  ANY
}

enum ExecutionStatus {
  SUCCESS
  FAILURE
  TIMEOUT
}
